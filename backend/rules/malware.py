"""
Malware Heuristics — detects malicious behavior patterns and suspicious
permission combinations typical of spyware, trojans, and ransomware.

IMPORTANT: This module requires MULTIPLE permission clusters to flag,
and uses contextual analysis to reduce false positives on legitimate apps.
A video app (YouTube) needing RECORD_AUDIO + CAMERA is normal.
A calculator app needing those is suspicious.
"""


MALWARE_HEURISTICS = [
    {
        "id": "MALH001",
        "name": "Spyware Behavior: Audio/Location + Stealth",
        "severity": "high",
        "owasp": "M6",
        # Require 3+ surveillance permissions, not just 2
        "permissions": [
            "android.permission.RECORD_AUDIO",
            "android.permission.ACCESS_FINE_LOCATION",
            "android.permission.READ_CONTACTS",
        ],
        "description": "App requests Audio Recording, Fine Location, AND Contact access. "
                       "This triple combination is suspicious for surveillance behavior.",
        "risk": "High risk of user surveillance if not justified by core functionality.",
    },
    {
        "id": "MALH002",
        "name": "SMS Fraud / Interception Pattern",
        "severity": "high",
        "owasp": "M6",
        "permissions": [
            "android.permission.SEND_SMS",
            "android.permission.RECEIVE_SMS",
            "android.permission.READ_SMS",
        ],
        "description": "Full SMS access cluster detected. App can send, receive, and read SMS. "
                       "This is a common pattern for billing fraud or OTP interception.",
        "risk": "Potential for financial fraud or account takeover.",
    },
    {
        "id": "MALH003",
        "name": "Persistence: Boot Survival",
        "severity": "info",  # Boot survival alone is very common and not malicious
        "owasp": "M8",
        "permissions": ["android.permission.RECEIVE_BOOT_COMPLETED"],
        "description": "App automatically starts on device boot. This is common for "
                       "messaging apps, alarms, and services. It is flagged for informational purposes.",
        "risk": "Persistence mechanism — normal for many legitimate apps.",
    },
    {
        "id": "MALH004",
        "name": "Overlay Attack Surface",
        "severity": "medium",  # Downgraded from high — PiP and legitimate overlays are common
        "owasp": "M8",
        "permissions": ["android.permission.SYSTEM_ALERT_WINDOW"],
        "description": "App can draw overlays over other apps. Used legitimately for "
                       "Picture-in-Picture, chat heads, and screen recording. However, "
                       "banking trojans abuse this for credential phishing.",
        "risk": "Legitimate for media apps; suspicious for utility/finance apps.",
    },
    {
        "id": "MALH005",
        "name": "Stealth Behavior: Hidden from Launcher",
        "severity": "high",
        "owasp": "M7",
        "pattern": "hidden_activity",
        "description": "No Launcher activity found, yet the app has many permissions. "
                       "Common stealth tactic for malware.",
        "risk": "App is attempting to hide its presence from the user.",
    },
]


def analyze_malware_heuristics(permissions: list, metadata: dict) -> list:
    """Check for malicious behavior clusters with context-awareness."""
    findings = []
    
    package_name = metadata.get("package", "").lower()
    
    # Whitelist known legitimate large apps to reduce false positives
    LEGIT_PACKAGES = [
        "org.telegram", "com.google", "com.spotify", "com.whatsapp", 
        "com.facebook", "com.instagram", "com.microsoft", "com.samsung",
        "org.mozilla", "com.android", "com.apple", "com.disney", "com.netflix"
    ]
    
    is_legit = any(lp in package_name for lp in LEGIT_PACKAGES)
    
    perms_set = set(permissions)

    for h in MALWARE_HEURISTICS:
        if "permissions" in h:
            # Skip aggressive malware checks for known legit apps unless it's critical
            if is_legit and h["severity"] in ("high", "critical") and h["id"] != "MALH002":
                continue
                
            required = h["permissions"]
            matches = [p for p in required if p in perms_set]
            if len(matches) == len(required):
                findings.append({
                    "id": h["id"],
                    "name": h["name"],
                    "severity": h["severity"],
                    "confidence": "medium",  # Always medium for heuristics
                    "owasp": h["owasp"],
                    "location": "AndroidManifest.xml",
                    "evidence": f"Permission Cluster: {', '.join(matches)}",
                    "description": h["description"],
                    "remediation": "Audit the requirement for this combination of permissions. "
                                   "If not essential for core functionality, remove them.",
                })

    # Check for Hidden App behavior
    if metadata.get("is_hidden") and len(perms_set) > 3:
        h = MALWARE_HEURISTICS[4]
        findings.append({
            "id": h["id"],
            "name": h["name"],
            "severity": h["severity"],
            "confidence": "high",
            "owasp": h["owasp"],
            "location": "AndroidManifest.xml",
            "evidence": "No activity with android.intent.category.LAUNCHER found",
            "description": h["description"],
            "remediation": "Ensure the app has a visible launcher activity.",
        })

    return findings
